# Sysctl security configuration for Proxmox
# Managed by Ansible - DO NOT EDIT MANUALLY

# Network Security Parameters
# Disable IPv4 forwarding
net.ipv4.ip_forward = 0

# Disable IPv6 if not needed
net.ipv6.conf.all.disable_ipv6 = {{ security_config.sysctl.disable_ipv6 | default(1) }}
net.ipv6.conf.default.disable_ipv6 = {{ security_config.sysctl.disable_ipv6 | default(1) }}

# Prevent SYN attack
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 5
net.ipv4.tcp_synack_retries = 2

# Protection against time-wait assassination
net.ipv4.tcp_rfc1337 = 1

# Protect against ICMP attacks
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.icmp_echo_ignore_all = {{ security_config.sysctl.ignore_icmp | default(0) }}

# Enable reverse path filtering
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Disable source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Disable redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Disable router advertisements
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# System Security Parameters
# Restrict kernel pointer access
kernel.kptr_restrict = 2

# Restrict access to kernel logs
kernel.dmesg_restrict = 1

# Enable ExecShield protection
kernel.exec-shield = 1
kernel.randomize_va_space = 2

# Protect against core dumps
fs.suid_dumpable = 0

# Increase system file descriptor limit
fs.file-max = {{ security_config.sysctl.file_max | default(65535) }}

# Increase system IP port limits
net.ipv4.ip_local_port_range = 2000 65000

# Control swapping behavior
vm.swappiness = {{ security_config.sysctl.swappiness | default(10) }}
vm.dirty_ratio = {{ security_config.sysctl.dirty_ratio | default(20) }}

# Protect against user namespace abuse
kernel.unprivileged_userns_clone = {{ security_config.sysctl.unprivileged_userns_clone | default(0) }}

# Protect against kernel exploits
kernel.sysrq = {{ security_config.sysctl.sysrq | default(0) }}
kernel.core_uses_pid = 1 
